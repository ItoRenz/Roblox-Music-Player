--[[
============================================
ROBLOX MUSIC PLAYER
Author: ItoRenz00
Version: 1.0.3
Description: Advanced music player with persistent state, loop modes, mobile support, and auto-play on first join
Place this script in: StarterPlayer > StarterPlayerScripts
============================================
--]]

-- ============================================
-- SERVICES & VARIABLES
-- ============================================

local Players = game:GetService("Players")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

-- ============================================
-- MUSIC CONFIGURATION
-- ============================================

local musicList = {
	{id = "rbxassetid://133857865643061", title = "Indonesia to Australia"},
	{id = "rbxassetid://114138177515042", title = "Where We Are"},
	{id = "rbxassetid://89968719801460", title = "Next"},
	{id = "rbxassetid://129988226070628", title = "DJ Nasty Girl"},
	{id = "rbxassetid://89610760702249", title = "Stereo Love"},
	{id = "rbxassetid://118390472006859", title = "DJ Party Shaker"},
	{id = "rbxassetid://90145710334449", title = "DJ World"},
	{id = "rbxassetid://89180400948567", title = "Phonk Toma"},
	{id = "rbxassetid://116239599730544", title = "Goat"},
	{id = "rbxassetid://135018311294635", title = "DJ Cinnamon"},
	{id = "rbxassetid://96077163288111", title = "Kita Usahakan Lagi"},
	{id = "rbxassetid://77533933904801", title = "Coba Coba"},
	{id = "rbxassetid://104207837699519", title = "Tabola bale"},
	{id = "rbxassetid://119254319180287", title = "Culik Aku Dong"},
	{id = "rbxassetid://116255319981650", title = "Jamilah aisyah"},
	{id = "rbxassetid://133361466559971", title = "Dame Um Grrr"},
	{id = "rbxassetid://80223079206027", title = "Kecewa"},
}

-- ============================================
-- STATE MANAGEMENT WITH PERSISTENT STORAGE
-- ============================================

local state = {
	currentIndex = 1,
	isPlaying = false,
	isUIVisible = false,
	loopMode = "all",
	volume = 5,
	wasPlayingBeforeDeath = false,
	savedTimePosition = 0,
	isDead = false,
	isFirstJoin = true
}

-- Save Data Functions
local function saveData(showLog)
	local success, err = pcall(function()
		local dataToSave = {
			currentIndex = state.currentIndex,
			isPlaying = state.isPlaying,
			loopMode = state.loopMode,
			volume = state.volume,
			timePosition = sound and sound.TimePosition or 0,
			isFirstJoin = false
		}
		
		_G.MusicPlayerData = dataToSave
		
		if showLog then
			print("üíæ Data saved - Playing: " .. tostring(state.isPlaying))
		end
	end)
	
	if not success then
		warn("Failed to save data: " .. tostring(err))
	end
end

local function loadData()
	local success, result = pcall(function()
		if _G.MusicPlayerData then
			local data = _G.MusicPlayerData
			
			state.currentIndex = data.currentIndex or 1
			state.isPlaying = data.isPlaying or false
			state.loopMode = data.loopMode or "all"
			state.volume = data.volume or 5
			state.savedTimePosition = data.timePosition or 0
			state.isFirstJoin = data.isFirstJoin == nil and true or data.isFirstJoin
			
			print("üìÇ Data loaded - Was Playing: " .. tostring(state.isPlaying))
			return true
		end
		return false
	end)
	
	return success and result
end

-- ============================================
-- SOUND SETUP
-- ============================================

local sound = Instance.new("Sound")
sound.Parent = SoundService
sound.Looped = false
sound.Volume = state.volume * 0.25
sound.Name = "MusicPlayerSound"

-- ============================================
-- UI SETUP
-- ============================================

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MusicPlayerGui"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local function createUIElement(className, properties)
	local element = Instance.new(className)
	for prop, value in pairs(properties) do
		element[prop] = value
	end
	return element
end

-- Toggle Button
local toggleButton = createUIElement("TextButton", {
	Name = "ToggleButton",
	Parent = screenGui,
	BackgroundColor3 = Color3.fromRGB(30, 30, 45),
	BorderSizePixel = 0,
	Text = "MUSIC",
	TextColor3 = Color3.fromRGB(255, 255, 255),
	Font = Enum.Font.GothamBold,
	ZIndex = 10,
	AutoButtonColor = false,
	Size = isMobile and UDim2.new(0, 65, 0, 25) or UDim2.new(0, 70, 0, 30),
	Position = isMobile and UDim2.new(0.5, -15, 0, 12) or UDim2.new(0.5, -190, 0, 12),
	TextSize = isMobile and 12 or 14
})

createUIElement("UICorner", {CornerRadius = UDim.new(0, 8), Parent = toggleButton})
createUIElement("UIStroke", {Color = Color3.fromRGB(100, 200, 255), Thickness = 2, Parent = toggleButton})

-- Main Frame
local mainFrame = createUIElement("Frame", {
	Name = "MusicPlayer",
	Parent = screenGui,
	BackgroundColor3 = Color3.fromRGB(25, 28, 38),
	BorderSizePixel = 0,
	Visible = false,
	ClipsDescendants = true,
	Size = isMobile and UDim2.new(0, 240, 0, 125) or UDim2.new(0, 280, 0, 130),
	Position = isMobile and UDim2.new(0.5, 55, 0, 12) or UDim2.new(0.5, -115, 0, 12)
})

createUIElement("UICorner", {CornerRadius = UDim.new(0, 8), Parent = mainFrame})
createUIElement("UIStroke", {Color = Color3.fromRGB(70, 180, 255), Thickness = 2.5, Parent = mainFrame})

local gradient = createUIElement("UIGradient", {Parent = mainFrame, Rotation = 45})
gradient.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(25, 28, 38)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(35, 40, 55))
}

-- Close Button
local closeBtn = createUIElement("TextButton", {
	Name = "CloseButton",
	Parent = mainFrame,
	BackgroundColor3 = Color3.fromRGB(200, 50, 50),
	BorderSizePixel = 0,
	Text = "X",
	TextColor3 = Color3.fromRGB(255, 255, 255),
	Font = Enum.Font.GothamBold,
	AutoButtonColor = false,
	ZIndex = 2,
	Size = isMobile and UDim2.new(0, 20, 0, 20) or UDim2.new(0, 18, 0, 18),
	Position = UDim2.new(1, -26, 0, 4),
	TextSize = isMobile and 11 or 12
})

createUIElement("UICorner", {CornerRadius = UDim.new(0, 6), Parent = closeBtn})

-- Title Label
local titleLabel = createUIElement("TextLabel", {
	Parent = mainFrame,
	BackgroundTransparency = 1,
	Text = "Music Player",
	TextColor3 = Color3.fromRGB(255, 255, 255),
	Font = Enum.Font.GothamBold,
	TextXAlignment = Enum.TextXAlignment.Left,
	Size = UDim2.new(1, -55, 0, 20),
	Position = UDim2.new(0, 8, 0, 4),
	TextSize = isMobile and 12 or 13
})

-- Divider Line
createUIElement("Frame", {
	Parent = mainFrame,
	BackgroundColor3 = Color3.fromRGB(70, 180, 255),
	BorderSizePixel = 0,
	BackgroundTransparency = 0.7,
	Size = UDim2.new(1, -16, 0, 1),
	Position = UDim2.new(0, 8, 0, 26)
})

-- Song Title
local songTitleLabel = createUIElement("TextLabel", {
	Parent = mainFrame,
	BackgroundTransparency = 1,
	Text = musicList[1].title,
	TextColor3 = Color3.fromRGB(255, 255, 255),
	Font = Enum.Font.GothamBold,
	TextXAlignment = Enum.TextXAlignment.Center,
	TextScaled = true,
	Size = UDim2.new(1, -20, 0, 24),
	Position = UDim2.new(0, 10, 0, 29)
})

-- Progress Bar
local progressBg = createUIElement("Frame", {
	Name = "ProgressBg",
	Parent = mainFrame,
	BackgroundColor3 = Color3.fromRGB(45, 50, 65),
	BorderSizePixel = 0,
	Size = UDim2.new(1, -20, 0, 4),
	Position = UDim2.new(0, 10, 0, 56)
})

createUIElement("UICorner", {CornerRadius = UDim.new(1, 0), Parent = progressBg})

local progressFill = createUIElement("Frame", {
	Name = "ProgressFill",
	Parent = progressBg,
	BackgroundColor3 = Color3.fromRGB(70, 180, 255),
	BorderSizePixel = 0,
	Size = UDim2.new(0, 0, 1, 0)
})

createUIElement("UICorner", {CornerRadius = UDim.new(1, 0), Parent = progressFill})

-- Time Display
local timeLabel = createUIElement("TextLabel", {
	Parent = mainFrame,
	BackgroundTransparency = 1,
	Size = UDim2.new(1, 0, 0, 12),
	Text = "00:00 / 00:00",
	TextColor3 = Color3.fromRGB(200, 210, 225),
	Font = Enum.Font.Gotham,
	TextXAlignment = Enum.TextXAlignment.Center,
	Position = UDim2.new(0, 0, 0, 62),
	TextSize = isMobile and 9 or 10
})

-- Loop Status Label
local loopStatusLabel = createUIElement("TextLabel", {
	Parent = mainFrame,
	BackgroundTransparency = 1,
	Text = "Loop: All",
	TextColor3 = Color3.fromRGB(70, 180, 255),
	Font = Enum.Font.Gotham,
	TextXAlignment = Enum.TextXAlignment.Center,
	Size = isMobile and UDim2.new(0, 55, 0, 12) or UDim2.new(0, 60, 0, 12),
	Position = UDim2.new(0, 10, 0, 78),
	TextSize = isMobile and 8 or 9
})

-- Volume Input
local volumeInput = createUIElement("TextBox", {
	Parent = mainFrame,
	BackgroundColor3 = Color3.fromRGB(45, 50, 65),
	BorderSizePixel = 0,
	Text = tostring(state.volume),
	TextColor3 = Color3.fromRGB(255, 255, 255),
	Font = Enum.Font.GothamBold,
	PlaceholderText = "0-10",
	ClearTextOnFocus = false,
	TextXAlignment = Enum.TextXAlignment.Center,
	Size = isMobile and UDim2.new(0, 45, 0, 26) or UDim2.new(0, 50, 0, 26),
	Position = isMobile and UDim2.new(1, -53, 0, 93) or UDim2.new(1, -58, 0, 93),
	TextSize = isMobile and 11 or 12
})

createUIElement("UICorner", {CornerRadius = UDim.new(1, 0), Parent = volumeInput})
createUIElement("UIStroke", {Color = Color3.fromRGB(70, 180, 255), Thickness = 0.5, Transparency = 0.5, Parent = volumeInput})

-- Controls Container
local controlsFrame = createUIElement("Frame", {
	Parent = mainFrame,
	BackgroundTransparency = 1,
	Size = UDim2.new(1, 0, 0, 32),
	Position = UDim2.new(0, 0, 0, 92)
})

-- Control Buttons
local loopBtn = createUIElement("TextButton", {
	Parent = controlsFrame,
	BackgroundTransparency = 1,
	BorderSizePixel = 0,
	Text = "üîÅ",
	TextColor3 = Color3.fromRGB(70, 180, 255),
	Font = Enum.Font.GothamBold,
	AutoButtonColor = false,
	Size = isMobile and UDim2.new(0, 26, 0, 26) or UDim2.new(0, 28, 0, 28),
	Position = isMobile and UDim2.new(0, 10, 0.5, -13) or UDim2.new(0, 10, 0.5, -14),
	TextSize = isMobile and 15 or 16
})

local prevBtn = createUIElement("TextButton", {
	Parent = controlsFrame,
	BackgroundTransparency = 1,
	BorderSizePixel = 0,
	Text = "‚èÆÔ∏è",
	TextColor3 = Color3.fromRGB(220, 220, 230),
	Font = Enum.Font.GothamBold,
	AutoButtonColor = false,
	Size = isMobile and UDim2.new(0, 26, 0, 26) or UDim2.new(0, 28, 0, 28),
	Position = isMobile and UDim2.new(0.5, -39, 0.5, -13) or UDim2.new(0.5, -42, 0.5, -14),
	TextSize = isMobile and 13 or 14
})

local playBtn = createUIElement("TextButton", {
	Parent = controlsFrame,
	BackgroundTransparency = 1,
	BorderSizePixel = 0,
	Text = "‚ñ∂Ô∏è",
	TextColor3 = Color3.fromRGB(70, 180, 255),
	Font = Enum.Font.GothamBold,
	AutoButtonColor = false,
	Size = isMobile and UDim2.new(0, 30, 0, 30) or UDim2.new(0, 32, 0, 32),
	Position = isMobile and UDim2.new(0.5, -15, 0.5, -15) or UDim2.new(0.5, -16, 0.5, -16),
	TextSize = isMobile and 17 or 18
})

local nextBtn = createUIElement("TextButton", {
	Parent = controlsFrame,
	BackgroundTransparency = 1,
	BorderSizePixel = 0,
	Text = "‚è≠Ô∏è",
	TextColor3 = Color3.fromRGB(220, 220, 230),
	Font = Enum.Font.GothamBold,
	AutoButtonColor = false,
	Size = isMobile and UDim2.new(0, 26, 0, 26) or UDim2.new(0, 28, 0, 28),
	Position = isMobile and UDim2.new(0.5, 13, 0.5, -13) or UDim2.new(0.5, 14, 0.5, -14),
	TextSize = isMobile and 13 or 14
})

-- ============================================
-- UTILITY FUNCTIONS
-- ============================================

local function formatTime(seconds)
	local mins = math.floor(seconds / 60)
	local secs = math.floor(seconds % 60)
	return string.format("%02d:%02d", mins, secs)
end

local function updateProgressBar()
	if sound.IsLoaded and sound.TimeLength > 0 then
		local progress = sound.TimePosition / sound.TimeLength
		progressFill:TweenSize(
			UDim2.new(progress, 0, 1, 0),
			Enum.EasingDirection.Out,
			Enum.EasingStyle.Linear,
			0.1,
			true
		)
		timeLabel.Text = formatTime(sound.TimePosition) .. " / " .. formatTime(sound.TimeLength)
	else
		timeLabel.Text = "00:00 / 00:00"
	end
end

local function updatePlayButton()
	playBtn.Text = state.isPlaying and "‚è∏Ô∏è" or "‚ñ∂Ô∏è"
end

local function updateLoopDisplay()
	if state.loopMode == "off" then
		loopStatusLabel.Text = "Loop: Off"
		loopStatusLabel.TextColor3 = Color3.fromRGB(150, 150, 160)
		loopBtn.Text = "üîÅ"
		loopBtn.TextColor3 = Color3.fromRGB(150, 150, 160)
		sound.Looped = false
	elseif state.loopMode == "all" then
		loopStatusLabel.Text = "Loop: All"
		loopStatusLabel.TextColor3 = Color3.fromRGB(70, 180, 255)
		loopBtn.Text = "üîÅ"
		loopBtn.TextColor3 = Color3.fromRGB(70, 180, 255)
		sound.Looped = false
	else
		loopStatusLabel.Text = "Loop: One"
		loopStatusLabel.TextColor3 = Color3.fromRGB(255, 150, 100)
		loopBtn.Text = "üîÇ"
		loopBtn.TextColor3 = Color3.fromRGB(255, 150, 100)
		sound.Looped = true
	end
end

-- ============================================
-- MUSIC CONTROL FUNCTIONS
-- ============================================

local function updateSong(shouldAutoPlay, resetPosition)
	local currentSong = musicList[state.currentIndex]
	sound.SoundId = currentSong.id
	songTitleLabel.Text = currentSong.title
	
	local wasPlaying = state.isPlaying
	
	sound.Loaded:Wait()
	
	local success = pcall(function()
		if resetPosition then
			sound.TimePosition = 0
		end
		
		if shouldAutoPlay and not state.isDead then
			sound:Play()
			state.isPlaying = true
		elseif wasPlaying then
			sound:Play()
			state.isPlaying = true
		end
	end)
	
	if not success then
		warn("‚ö†Ô∏è Failed to load: " .. currentSong.title)
		task.wait(0.5)
		nextSong()
	else
		if sound.TimeLength > 0 then
			timeLabel.Text = "00:00 / " .. formatTime(sound.TimeLength)
		end
	end
	
	updatePlayButton()
	saveData()
end

local function togglePlay()
	state.isPlaying = not state.isPlaying
	
	if state.isPlaying then
		sound:Resume()
	else
		sound:Pause()
	end
	
	updatePlayButton()
	saveData()
end

local function nextSong()
	sound:Stop()
	state.currentIndex = (state.currentIndex % #musicList) + 1
	updateSong(state.isPlaying, true)
end

local function prevSong()
	sound:Stop()
	state.currentIndex = state.currentIndex > 1 and state.currentIndex - 1 or #musicList
	updateSong(state.isPlaying, true)
end

local function toggleLoop()
	if state.loopMode == "off" then
		state.loopMode = "all"
	elseif state.loopMode == "all" then
		state.loopMode = "one"
	else
		state.loopMode = "off"
	end
	updateLoopDisplay()
	saveData()
end

-- ============================================
-- EVENT HANDLERS
-- ============================================

toggleButton.MouseButton1Click:Connect(function()
	state.isUIVisible = not state.isUIVisible
	mainFrame.Visible = state.isUIVisible
end)

closeBtn.MouseButton1Click:Connect(function()
	state.isUIVisible = false
	mainFrame.Visible = false
end)

playBtn.MouseButton1Click:Connect(togglePlay)
nextBtn.MouseButton1Click:Connect(nextSong)
prevBtn.MouseButton1Click:Connect(prevSong)
loopBtn.MouseButton1Click:Connect(toggleLoop)

sound.Ended:Connect(function()
	print("üéµ Song ended - Loop mode: " .. state.loopMode)
	if state.loopMode == "all" then
		nextSong()
	elseif state.loopMode == "off" then
		state.isPlaying = false
		updatePlayButton()
		saveData()
	end
	-- loopMode "one" will loop automatically because sound.Looped = true
end)

volumeInput.FocusLost:Connect(function()
	local inputValue = tonumber(volumeInput.Text)
	if inputValue then
		local clampedValue = math.clamp(inputValue, 0, 10)
		sound.Volume = clampedValue * 0.25
		volumeInput.Text = tostring(clampedValue)
		state.volume = clampedValue
		saveData()
	else
		volumeInput.Text = tostring(state.volume)
	end
end)

-- ============================================
-- UPDATE LOOP
-- ============================================

RunService.Heartbeat:Connect(function()
	if state.isPlaying and sound.IsPlaying and not state.isDead then
		updateProgressBar()
	end
end)

-- Auto-save every 30 seconds
task.spawn(function()
	while true do
		task.wait(30)
		if state.isPlaying then
			saveData(false)
		end
	end
end)

-- ============================================
-- DEATH & RESPAWN SYSTEM
-- ============================================

local function setupCharacter(character)
	local humanoid = character:WaitForChild("Humanoid")
	
	humanoid.Died:Connect(function()
		print("üíÄ Player died - Music continues")
		
		state.isDead = true
		state.wasPlayingBeforeDeath = state.isPlaying
		state.savedTimePosition = sound.TimePosition
		
		saveData(false)
	end)
end

player.CharacterAdded:Connect(function(character)
	print("üîÑ Character spawned")
	
	setupCharacter(character)
	
	task.wait(0.5)
	
	state.isDead = false
	
	-- If this is initial spawn and music should be playing, ensure it continues
	if state.isPlaying then
		print("üéµ Ensuring music continues after spawn...")
		if not sound.IsPlaying then
			sound:Play()
			print("‚ñ∂Ô∏è Restarted music playback")
		else
			print("‚úÖ Music already playing")
		end
	elseif state.wasPlayingBeforeDeath then
		state.isPlaying = true
		
		if not sound.IsPlaying then
			sound:Play()
		end
	else
		state.isPlaying = false
		
		if sound.IsPlaying then
			sound:Pause()
		end
	end
	
	updatePlayButton()
	saveData(false)
end)

-- ============================================
-- INITIALIZATION
-- ============================================

local dataLoaded = loadData()

if dataLoaded then
	print("üìÇ Loading previous session...")
	volumeInput.Text = tostring(state.volume)
	sound.Volume = state.volume * 0.25
end

updateLoopDisplay()

-- Setup character listener FIRST before initializing music
if player.Character then
	setupCharacter(player.Character)
end

-- AUTO-PLAY LOGIC: Always play music on first join
if not dataLoaded or state.isFirstJoin then
	print("üéµ First join detected - Auto-playing music...")
	
	-- Load the song first
	local currentSong = musicList[state.currentIndex]
	sound.SoundId = currentSong.id
	songTitleLabel.Text = currentSong.title
	
	-- Wait for sound to load
	sound.Loaded:Wait()
	task.wait(0.2) -- Increased delay to ensure character is fully loaded
	
	-- Set state and play
	state.isPlaying = true
	state.isFirstJoin = false
	
	-- Make sure sound is not looped initially (loop mode "all" handles this differently)
	sound.Looped = false
	
	sound:Play()
	
	-- Verify it's playing
	task.wait(0.1)
	if not sound.IsPlaying then
		warn("‚ö†Ô∏è Sound failed to play, retrying...")
		sound:Play()
	end
	
	updatePlayButton()
	
	-- Update time label
	if sound.TimeLength > 0 then
		timeLabel.Text = "00:00 / " .. formatTime(sound.TimeLength)
	end
	
	saveData(true)
	print("‚úÖ Music started playing! IsPlaying: " .. tostring(sound.IsPlaying))
	print("üìä Sound Length: " .. tostring(sound.TimeLength) .. "s")
	
elseif dataLoaded and state.isPlaying then
	print("üéµ Restoring previous session - Music was playing")
	
	-- Load the saved song
	local currentSong = musicList[state.currentIndex]
	sound.SoundId = currentSong.id
	songTitleLabel.Text = currentSong.title
	sound.Loaded:Wait()
	task.wait(0.1)
	
	-- Resume playback
	sound.Looped = (state.loopMode == "one")
	sound:Play()
	updatePlayButton()
	
	if sound.TimeLength > 0 then
		timeLabel.Text = "00:00 / " .. formatTime(sound.TimeLength)
	end
	
else
	print("‚èπÔ∏è Music player ready - Press play to start")
	
	-- Load the song but don't play
	local currentSong = musicList[state.currentIndex]
	sound.SoundId = currentSong.id
	songTitleLabel.Text = currentSong.title
	sound.Loaded:Wait()
	
	state.isPlaying = false
	sound.Looped = false
	updatePlayButton()
	
	if sound.TimeLength > 0 then
		timeLabel.Text = "00:00 / " .. formatTime(sound.TimeLength)
	end
end

print("üéµ Music Player Loaded!")
print("üìã Total Songs: " .. #musicList)
print("üíæ Save Data: " .. (dataLoaded and "Loaded" or "New Session"))
print("üîÅ Default Loop Mode: All")
print("üéº Auto-Play: " .. (state.isFirstJoin and "ENABLED" or "From Previous State"))

updatePlayButton()
